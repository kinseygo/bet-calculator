<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>投注计算器 v12.3（融合版）</title>
<style>
:root{--bg:#ffffff;--accent:#1e40af;--muted:#64748b;--danger:#dc2626;--neutral:#0f172a}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",Helvetica,Arial;background:var(--bg);color:var(--neutral)}
.header{padding:12px;background:linear-gradient(180deg,#fff,#f3f7ff);border-bottom:1px solid #eef2ff;display:flex;align-items:center;justify-content:space-between}
.title{font-weight:800;color:var(--accent)}
.container{max-width:1200px;margin:12px auto;padding:12px}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
.select,input[type=number],button{padding:8px 10px;border-radius:8px;border:1px solid #e6eef8;background:#fff;color:var(--neutral);font-weight:600;cursor:pointer}
.button-primary{background:linear-gradient(180deg,var(--accent),#1241a3);color:#fff;border:0}
.card{background:#f8fafc;padding:10px;border-radius:10px;border:1px solid #eef2ff;margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px}
.cell{background:#fff;padding:10px;border-radius:8px;border:1px solid #eef2ff;display:flex;flex-direction:column;gap:6px}
.row{display:flex;align-items:center;gap:8px}
.label{width:34px;font-weight:700;text-align:center;color:var(--accent)}
.expr{flex:1;padding:8px;border-radius:8px;border:1px solid #eef2ff;background:transparent;color:var(--neutral)}
.value{min-width:90px;text-align:right;font-weight:700}
.note{font-size:13px;color:var(--muted)}
.diff{font-weight:700}
.diff.positive{color:var(--accent)}
.diff.negative{color:var(--danger)}
.diff.neutral{color:var(--neutral)}
.table-wrap{margin-top:12px;background:#fff;border:1px solid #eef2ff;border-radius:10px;padding:10px}
.table{width:100%;border-collapse:collapse;font-size:14px}
.table th,.table td{padding:6px 8px;border-bottom:1px solid #f1f5f9;text-align:left}
.table th{background:#fbfdff;font-weight:700;color:var(--muted)}
.footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}
.small-btn{padding:6px 8px;border-radius:6px;border:1px solid #e6eef8;background:#fff;cursor:pointer;font-weight:600}
@media (max-width:560px){ .grid{grid-template-columns:repeat(2,1fr)} .label{width:28px} }
</style>
</head>
<body>
<header class="header">
  <div class="title">投注计算器 v12.3（融合版）</div>
  <div style="font-size:13px;color:var(--muted)">保留算式输入、平值、自动保存与排序</div>
</header>

<div class="container">
  <div class="controls card">
    <button id="saveBtn" class="select">保存当前</button>
    <button id="clearCurrent" class="select">清空当前输入</button>
    <button id="clearStorage" class="select">清空本地记录</button>
    <button id="randomBtn" class="button-primary">随机填值（1-1000）</button>
    <button id="exportCSV" class="select">导出 CSV</button>
    <label>倍数：</label>
    <select id="multScheme" class="select">
      <option value="45">45倍</option><option value="46">46倍</option><option value="47">47倍</option><option value="48">48倍</option><option value="49">49倍</option><option value="custom">自定义</option>
    </select>
    <input type="number" id="customMultiplier" value="45" style="width:100px">
    <button id="applyMult" class="select">应用倍数</button>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="note">说明：输入框支持算式（例：10+5-2），点击“平值”会把该项填为使其盈亏为平。</div>
      <div style="font-weight:800">当前总和：<span id="totalSum">0</span></div>
    </div>
  </div>

  <div id="grid" class="grid"></div>

  <div id="compareResult" class="table-wrap">页面加载完成，编辑任何输入框自动更新。</div>

  <div class="table-wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:700">按数值从高到低排序（实时）</div>
      <div><button id="exportSortedCSV" class="small-btn">导出排序 CSV</button></div>
    </div>
    <table class="table" id="sortedTable">
      <thead><tr><th>排名</th><th>编号</th><th>数值</th><th>差值</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="footer">注：随机仅填入 1–1000 正整数；自动备份使用 localStorage。</div>
</div>

<script>
const STORAGE_KEY = 'bet_calc_v12_3_storage_v1';

// generate 49 cells
const grid = document.getElementById('grid');
for(let i=1;i<=49;i++){
  const cell = document.createElement('div');
  cell.className = 'cell';
  cell.id = 'cell_'+i;
  cell.innerHTML = `
    <div class="row">
      <div class="label">${String(i).padStart(2,'0')}</div>
      <input class="expr" id="expr_${i}" placeholder="输入数值或算式">
      <div class="value" id="value_${i}">0</div>
    </div>
    <div class="row">
      <div class="note"><span id="diff_${i}" class="diff diff-neutral">差值: 0 平</span></div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div id="req_${i}" class="note" style="min-width:140px;text-align:right">平衡值: -</div>
        <button class="small-btn" id="flat_${i}" data-id="${i}">平值</button>
      </div>
    </div>
  `;
  grid.appendChild(cell);
}

// safe evaluator
function safeEvalExpr(src){
  if(src===undefined || src===null) return 0;
  let s = String(src).trim();
  if(!s) return 0;
  s = s.replace(/×/g,'*').replace(/÷/g,'/').replace(/，/g,',').replace(/／/g,'/').replace(/－/g,'-');
  if(/[^0-9+\-*/().\s,^%]/.test(s)) throw new Error('表达式含非法字符');
  s = s.replace(/\^/g,'**');
  const fn = new Function('return ('+s+');');
  const val = fn();
  if(typeof val === 'number' && !Number.isNaN(val)) return val;
  return Number(val);
}

// collect refs
const items = [];
for(let i=1;i<=49;i++){
  items.push({
    id:i,
    expr: document.getElementById('expr_'+i),
    valEl: document.getElementById('value_'+i),
    diffEl: document.getElementById('diff_'+i),
    reqEl: document.getElementById('req_'+i),
    flatBtn: document.getElementById('flat_'+i)
  });
}

let multiplier = 45;
let suppressAutoSave = false;

// storage helpers
function saveAll(){
  if(suppressAutoSave) return;
  const data = { multiplier, values: items.map(it=> it.expr.value || ''), ts: Date.now() };
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){ console.warn('保存失败', e); }
}
function loadAll(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;
    const obj = JSON.parse(raw);
    if(obj.multiplier) multiplier = obj.multiplier;
    if(Array.isArray(obj.values)){
      for(let i=0;i<items.length && i<obj.values.length;i++) items[i].expr.value = obj.values[i] || '';
    }
    document.getElementById('customMultiplier').value = multiplier;
    document.getElementById('multScheme').value = (['45','46','47','48','49'].includes(String(multiplier))) ? String(multiplier) : 'custom';
    return true;
  }catch(e){ return false; }
}
function clearStorage(){
  localStorage.removeItem(STORAGE_KEY);
  alert('本地记录已清除');
}

function updateValue(i){
  const it = items[i];
  try{
    const v = safeEvalExpr(it.expr.value || '0');
    it.valEl.textContent = Number.isFinite(v) ? (Math.round(v*1e6)/1e6) : String(v);
    it.valEl.style.color = '';
    return v;
  }catch(e){
    it.valEl.textContent = '错误';
    it.valEl.style.color = 'var(--danger)';
    return NaN;
  }
}
function updateAllValues(){ return items.map((_,i)=> updateValue(i)); }

function computeAndDisplay(){
  const vals = updateAllValues();
  const nums = vals.map(v=> Number.isFinite(v)?v:0);
  const total = nums.reduce((a,b)=>a+b,0);
  document.getElementById('totalSum').textContent = Number.isFinite(total)?(Math.round(total*1e6)/1e6):String(total);
  const diffs = [];
  for(let i=0;i<nums.length;i++){
    let sumOthers = 0;
    for(let j=0;j<nums.length;j++){ if(j!==i) sumOthers += nums[j]; }
    const diff = sumOthers - nums[i] * multiplier;
    diffs.push(diff);
    const fmt = x => Number.isFinite(x)?(Math.round(x*1e6)/1e6):String(x);
    const diffEl = items[i].diffEl;
    const reqEl = items[i].reqEl;
    if(diff>0){ diffEl.textContent = `差值: ${fmt(diff)} 盈`; diffEl.className='diff positive'; items[i].expr.style.color='var(--accent)'; }
    else if(diff<0){ diffEl.textContent = `差值: ${fmt(diff)} 亏`; diffEl.className='diff negative'; items[i].expr.style.color='var(--danger)'; }
    else{ diffEl.textContent = `差值: 0 平`; diffEl.className='diff neutral'; items[i].expr.style.color=''; }
    const required = sumOthers / multiplier;
    reqEl.textContent = `平衡值: ${Number.isFinite(required)?fmt(required):'-'}`;
  }
  updateSortedTable(nums,diffs);
  document.getElementById('compareResult').textContent = `已计算：总和=${Math.round(total*100)/100}；盈 ${diffs.filter(d=>d>0).length} 项，亏 ${diffs.filter(d=>d<0).length} 项。`;
  saveAll();
}

function updateSortedTable(nums,diffs){
  const rows = nums.map((v,i)=>({id:i+1,value:v,diff:diffs[i]}));
  rows.sort((a,b)=> b.value - a.value || b.diff - a.diff);
  const tbody = document.querySelector('#sortedTable tbody'); tbody.innerHTML = '';
  const fmt = x => Number.isFinite(x)?(Math.round(x*1e6)/1e6):String(x);
  rows.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="padding:6px 8px">${idx+1}</td><td>#${r.id}</td><td>${fmt(r.value)}</td><td><span class="${r.diff>0?'diff positive':(r.diff<0?'diff negative':'diff neutral')}">${fmt(r.diff)} ${r.diff>0?'盈':(r.diff<0?'亏':'平')}</span></td>`;
    tbody.appendChild(tr);
  });
}

// controls wiring
document.getElementById('multScheme').addEventListener('change', (e)=>{ const v=e.target.value; if(v==='custom') document.getElementById('customMultiplier').style.display='inline-block'; else document.getElementById('customMultiplier').value = v; });
document.getElementById('applyMult').addEventListener('click', ()=>{ const val = parseFloat(document.getElementById('customMultiplier').value); if(!isFinite(val) || val<=0){ alert('请输入合法倍数'); return; } multiplier = val; computeAndDisplay(); });
document.getElementById('randomBtn').addEventListener('click', ()=>{ suppressAutoSave=true; for(let i=0;i<items.length;i++){ items[i].expr.value = String(Math.floor(Math.random()*1000) + 1); } suppressAutoSave=false; computeAndDisplay(); });
document.getElementById('saveBtn').addEventListener('click', ()=>{ saveAll(); alert('当前已保存到本地'); });
document.getElementById('clearCurrent').addEventListener('click', ()=>{ suppressAutoSave=true; for(let i=0;i<items.length;i++){ items[i].expr.value = ''; items[i].valEl.textContent='0'; items[i].diffEl.textContent='差值: 0 平'; items[i].reqEl.textContent='平衡值: -'; items[i].expr.style.color=''; } suppressAutoSave=false; computeAndDisplay(); });
document.getElementById('clearStorage').addEventListener('click', ()=>{ if(confirm('确认清除本地保存的数据？此操作不可撤销。')){ clearStorage(); suppressAutoSave=true; for(let i=0;i<items.length;i++){ items[i].expr.value=''; items[i].valEl.textContent='0'; items[i].diffEl.textContent='差值: 0 平'; items[i].reqEl.textContent='平衡值: -'; items[i].expr.style.color=''; } suppressAutoSave=false; computeAndDisplay(); } });

document.getElementById('exportCSV').addEventListener('click', ()=>{
  const vals = updateAllValues();
  const nums = vals.map(v=> Number.isFinite(v)?v:0);
  const rows=[['id','expression','value','sumOthers_minus_value_times_multiplier']];
  for(let i=0;i<items.length;i++){
    const expr = items[i].expr.value.replace(/"/g,'""');
    const v = Number.isFinite(vals[i]) ? vals[i] : '';
    let sumOthers=0; for(let j=0;j<nums.length;j++){ if(j!==i) sumOthers += nums[j]; }
    const diff = Number.isFinite(v)?(sumOthers - v*multiplier):'';
    rows.push([i+1, `"${expr}"`, v, diff]);
  }
  rows.push([]); rows.push(['排名','编号','数值','差值']);
  const sorted = nums.map((v,i)=>({id:i+1,value:v,diff:(function(){ let so=0; for(let j=0;j<nums.length;j++){ if(j!==i) so+=nums[j]; } return so - v*multiplier; })()})).sort((a,b)=> b.value - a.value || b.diff - a.diff);
  sorted.forEach((r, idx)=> rows.push([idx+1, r.id, r.value, r.diff]));
  const csv = rows.map(r=> r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'bet_calc_v12_3_export.csv'; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('exportSortedCSV').addEventListener('click', ()=>{
  const vals = updateAllValues();
  const nums = vals.map(v=> Number.isFinite(v)?v:0);
  const sorted = nums.map((v,i)=>({id:i+1,value:v,diff:(function(){ let so=0; for(let j=0;j<nums.length;j++){ if(j!==i) so+=nums[j]; } return so - v*multiplier; })()})).sort((a,b)=> b.value - a.value || b.diff - a.diff);
  const rows=[['排名','编号','数值','差值']]; sorted.forEach((r,idx)=> rows.push([idx+1, r.id, r.value, r.diff]));
  const csv = rows.map(r=> r.join(',')).join('\n'); const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href = url; a.download = 'bet_calc_v12_3_sorted.csv'; a.click(); URL.revokeObjectURL(url);
});

// flat button binding
for(let i=0;i<items.length;i++){
  items[i].flatBtn.addEventListener('click', (event)=>{
    const idx = parseInt(event.currentTarget.dataset.id,10) - 1;
    const vals = updateAllValues();
    const nums = vals.map(v=> Number.isFinite(v)?v:0);
    let sumOthers = 0; for(let j=0;j<nums.length;j++){ if(j!==idx) sumOthers += nums[j]; }
    const required = sumOthers / multiplier;
    items[idx].expr.value = String(Number.isFinite(required)?(Math.round(required*1e6)/1e6):'');
    computeAndDisplay();
  });
}

// autosave debounce
let saveTimer = null;
items.forEach((it, idx)=>{
  it.expr.addEventListener('input', ()=>{
    if(saveTimer) clearTimeout(saveTimer);
    computeAndDisplay();
    if(!suppressAutoSave){
      saveTimer = setTimeout(()=>{ saveAll(); }, 800);
    }
  });
});

// load & init
loadAll();
computeAndDisplay();

// helper used by exports
function updateAllValues(){ return items.map((_,i)=> updateValue(i)); }

</script>
</body>
</html>
